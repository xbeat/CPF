<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Panel - CPF Dashboard</title>
    <link rel="stylesheet" href="css/auth.css">
    <style>
        /* Admin-specific overrides */
        body {
            background: var(--bg-gray);
            display: block;
            padding: 0;
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius);
            cursor: pointer;
        }

        /* Sidebar user info */
        .sidebar-user {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .sidebar-user-info {
            flex: 1;
            overflow: hidden;
        }

        .sidebar-user-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-role {
            font-size: 12px;
            opacity: 0.7;
            text-transform: capitalize;
        }

        /* Nav sections */
        .nav-section {
            padding: 16px 24px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
        }

        /* Search & Filters */
        .filters-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: white;
            min-width: 150px;
        }

        /* User avatar in table */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-light);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info-cell {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Actions dropdown */
        .actions-dropdown {
            position: relative;
        }

        .actions-btn {
            background: none;
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 13px;
        }

        .actions-btn:hover {
            background: var(--bg-gray);
        }

        .actions-menu {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 160px;
            z-index: 100;
            display: none;
        }

        .actions-menu.show {
            display: block;
        }

        .actions-menu-item {
            display: block;
            width: 100%;
            padding: 10px 16px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
        }

        .actions-menu-item:hover {
            background: var(--bg-gray);
        }

        .actions-menu-item.danger {
            color: var(--danger);
        }

        .actions-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings form */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .settings-section {
            background: var(--bg-gray);
            padding: 20px;
            border-radius: var(--radius);
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle switch */
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: var(--transition-fast);
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Audit log */
        .audit-entry {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .audit-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .audit-icon.login { background: var(--success-light); }
        .audit-icon.logout { background: var(--info-light); }
        .audit-icon.failed { background: var(--danger-light); }
        .audit-icon.change { background: var(--warning-light); }
        .audit-icon.admin { background: var(--primary); color: white; }

        .audit-content {
            flex: 1;
        }

        .audit-action {
            font-weight: 500;
        }

        .audit-details {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .audit-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        /* Loading spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .admin-sidebar.open {
                transform: translateX(0);
            }

            .admin-main {
                margin-left: 0;
                padding: 80px 16px 16px;
            }

            .filters-bar {
                flex-direction: column;
            }

            .search-input, .filter-select {
                width: 100%;
            }

            .table-responsive {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="sidebar-logo">
                <span>üß†</span> CPF Admin
            </div>

            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="userAvatar">--</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="userName">Loading...</div>
                    <div class="sidebar-user-role" id="userRole">--</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section" data-i18n="admin.navigation">Navigation</div>

                <a href="#users" class="nav-item active" data-section="users">
                    <span>üë•</span>
                    <span data-i18n="admin.users">Users</span>
                </a>

                <a href="#pending" class="nav-item" data-section="pending">
                    <span>‚è≥</span>
                    <span data-i18n="admin.pendingApprovals">Pending Approvals</span>
                    <span class="badge hidden" id="pendingBadge">0</span>
                </a>

                <a href="#audit" class="nav-item" data-section="audit">
                    <span>üìã</span>
                    <span data-i18n="admin.auditLog">Audit Log</span>
                </a>

                <div class="nav-section super-admin-only" data-i18n="admin.administration">Administration</div>

                <a href="#settings" class="nav-item super-admin-only" data-section="settings">
                    <span>‚öôÔ∏è</span>
                    <span data-i18n="admin.settings">Settings</span>
                </a>

                <div class="nav-section" data-i18n="admin.account">Account</div>

                <a href="#" class="nav-item" id="logoutBtn">
                    <span>üö™</span>
                    <span data-i18n="admin.logout">Logout</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <div>
                    <h1 id="pageTitle" data-i18n="admin.title">User Management</h1>
                    <p class="text-muted text-small" id="pageSubtitle"></p>
                </div>
                <div class="flex gap-1">
                    <!-- Language Selector -->
                    <div class="language-selector" style="position: relative; top: auto; right: auto;">
                        <button class="btn btn-secondary" id="langBtn" style="padding: 8px 12px;">
                            <span id="currentLang">EN</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="language-dropdown" id="langDropdown">
                            <a href="#" class="language-option active" data-lang="en-US">üá∫üá∏ English</a>
                            <a href="#" class="language-option" data-lang="it-IT">üáÆüáπ Italiano</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalUsers">--</div>
                    <div class="stat-label" data-i18n="admin.stats.totalUsers">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statActiveUsers">--</div>
                    <div class="stat-label" data-i18n="admin.stats.activeUsers">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPendingUsers">--</div>
                    <div class="stat-label" data-i18n="admin.stats.pendingApproval">Pending Approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLockedUsers">--</div>
                    <div class="stat-label" data-i18n="admin.stats.lockedUsers">Locked Users</div>
                </div>
            </div>

            <!-- Users Section -->
            <section class="card tab-content active" id="usersSection">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="admin.allUsers">All Users</h2>
                    <button class="btn btn-primary btn-sm" id="refreshUsersBtn">
                        <span>üîÑ</span>
                        <span data-i18n="admin.refresh">Refresh</span>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="filters-bar">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search by name or email...">
                        <select class="filter-select" id="statusFilter">
                            <option value="" data-i18n="admin.filter.allStatuses">All Statuses</option>
                            <option value="active" data-i18n="admin.filter.active">Active</option>
                            <option value="pending_verification" data-i18n="admin.filter.pendingVerification">Pending Verification</option>
                            <option value="pending_approval" data-i18n="admin.filter.pendingApproval">Pending Approval</option>
                            <option value="locked" data-i18n="admin.filter.locked">Locked</option>
                            <option value="suspended" data-i18n="admin.filter.suspended">Suspended</option>
                            <option value="expired" data-i18n="admin.filter.expired">Expired</option>
                            <option value="deactivated" data-i18n="admin.filter.deactivated">Deactivated</option>
                        </select>
                        <select class="filter-select" id="roleFilter">
                            <option value="" data-i18n="admin.filter.allRoles">All Roles</option>
                            <option value="super_admin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="auditor">Auditor</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>

                    <!-- Users Table -->
                    <div class="table-responsive">
                        <table class="table" id="usersTable">
                            <thead>
                                <tr>
                                    <th data-i18n="admin.table.user">User</th>
                                    <th data-i18n="admin.table.role">Role</th>
                                    <th data-i18n="admin.table.status">Status</th>
                                    <th data-i18n="admin.table.lastLogin">Last Login</th>
                                    <th data-i18n="admin.table.expiresAt">Expires</th>
                                    <th data-i18n="admin.table.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="usersPagination">
                        <div class="pagination-info" id="paginationInfo">
                            Showing 0 of 0 users
                        </div>
                        <div class="pagination-buttons">
                            <button class="btn btn-secondary btn-sm" id="prevPageBtn" disabled>
                                <span data-i18n="admin.pagination.prev">Previous</span>
                            </button>
                            <button class="btn btn-secondary btn-sm" id="nextPageBtn" disabled>
                                <span data-i18n="admin.pagination.next">Next</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pending Approvals Section -->
            <section class="card tab-content" id="pendingSection">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="admin.pendingApprovals">Pending Approvals</h2>
                    <button class="btn btn-primary btn-sm" id="refreshPendingBtn">
                        <span>üîÑ</span>
                        <span data-i18n="admin.refresh">Refresh</span>
                    </button>
                </div>
                <div class="card-body">
                    <div id="pendingList">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="empty-state hidden" id="pendingEmpty">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div class="empty-state-title" data-i18n="admin.noPending">No Pending Approvals</div>
                        <p data-i18n="admin.noPendingDesc">All user registrations have been processed.</p>
                    </div>
                </div>
            </section>

            <!-- Audit Log Section -->
            <section class="card tab-content" id="auditSection">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="admin.auditLog">Audit Log</h2>
                    <div class="flex gap-1">
                        <select class="filter-select" id="auditActionFilter" style="margin: 0;">
                            <option value="" data-i18n="admin.filter.allActions">All Actions</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="login_failed">Login Failed</option>
                            <option value="password_reset">Password Reset</option>
                            <option value="user_created">User Created</option>
                            <option value="user_approved">User Approved</option>
                            <option value="user_rejected">User Rejected</option>
                            <option value="user_locked">User Locked</option>
                            <option value="user_unlocked">User Unlocked</option>
                            <option value="role_changed">Role Changed</option>
                        </select>
                        <button class="btn btn-primary btn-sm" id="refreshAuditBtn">
                            <span>üîÑ</span>
                        </button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="auditList">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="empty-state hidden" id="auditEmpty">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title" data-i18n="admin.noAudit">No Audit Entries</div>
                        <p data-i18n="admin.noAuditDesc">No activity has been recorded yet.</p>
                    </div>
                </div>
                <div class="pagination" style="padding: 16px 24px;">
                    <div class="pagination-info" id="auditPaginationInfo">--</div>
                    <div class="pagination-buttons">
                        <button class="btn btn-secondary btn-sm" id="auditPrevBtn" disabled>Previous</button>
                        <button class="btn btn-secondary btn-sm" id="auditNextBtn" disabled>Next</button>
                    </div>
                </div>
            </section>

            <!-- Settings Section (Super Admin Only) -->
            <section class="card tab-content super-admin-only" id="settingsSection">
                <div class="card-header">
                    <h2 class="card-title" data-i18n="admin.settings">Settings</h2>
                    <button class="btn btn-primary btn-sm" id="saveSettingsBtn">
                        <span>üíæ</span>
                        <span data-i18n="admin.saveSettings">Save Settings</span>
                    </button>
                </div>
                <div class="card-body">
                    <div class="settings-grid">
                        <!-- Registration Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" data-i18n="admin.settings.registration">Registration</h3>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.allowRegistration">Allow Registration</div>
                                    <div class="setting-description" data-i18n="admin.settings.allowRegistrationDesc">Enable public user registration</div>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" id="settingAllowRegistration" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.requireApproval">Require Approval</div>
                                    <div class="setting-description" data-i18n="admin.settings.requireApprovalDesc">New users need admin approval</div>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" id="settingRequireApproval" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.requireEmailVerification">Require Email Verification</div>
                                    <div class="setting-description" data-i18n="admin.settings.requireEmailVerificationDesc">Users must verify email before access</div>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" id="settingRequireEmailVerification" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.defaultRole">Default Role</div>
                                    <div class="setting-description" data-i18n="admin.settings.defaultRoleDesc">Role assigned to new users</div>
                                </div>
                                <select class="filter-select" id="settingDefaultRole" style="min-width: 120px;">
                                    <option value="viewer">Viewer</option>
                                    <option value="auditor">Auditor</option>
                                </select>
                            </div>
                        </div>

                        <!-- Security Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" data-i18n="admin.settings.security">Security</h3>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.maxLoginAttempts">Max Login Attempts</div>
                                    <div class="setting-description" data-i18n="admin.settings.maxLoginAttemptsDesc">Before account lockout</div>
                                </div>
                                <input type="number" class="form-input" id="settingMaxLoginAttempts" value="5" min="3" max="10" style="width: 80px;">
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.sessionTimeout">Session Timeout (hours)</div>
                                    <div class="setting-description" data-i18n="admin.settings.sessionTimeoutDesc">Auto-logout after inactivity</div>
                                </div>
                                <input type="number" class="form-input" id="settingSessionTimeout" value="24" min="1" max="168" style="width: 80px;">
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.passwordExpiry">Password Expiry (days)</div>
                                    <div class="setting-description" data-i18n="admin.settings.passwordExpiryDesc">0 = never expires</div>
                                </div>
                                <input type="number" class="form-input" id="settingPasswordExpiry" value="0" min="0" max="365" style="width: 80px;">
                            </div>
                        </div>

                        <!-- Account Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" data-i18n="admin.settings.accounts">Accounts</h3>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.defaultExpiry">Default Account Expiry (days)</div>
                                    <div class="setting-description" data-i18n="admin.settings.defaultExpiryDesc">0 = never expires</div>
                                </div>
                                <input type="number" class="form-input" id="settingDefaultExpiry" value="365" min="0" max="3650" style="width: 80px;">
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.expiryWarning">Expiry Warning (days)</div>
                                    <div class="setting-description" data-i18n="admin.settings.expiryWarningDesc">Days before expiry to warn user</div>
                                </div>
                                <input type="number" class="form-input" id="settingExpiryWarning" value="14" min="1" max="90" style="width: 80px;">
                            </div>
                        </div>

                        <!-- Notification Settings -->
                        <div class="settings-section">
                            <h3 class="settings-section-title" data-i18n="admin.settings.notifications">Notifications</h3>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.notifyNewUser">Notify on New Registration</div>
                                    <div class="setting-description" data-i18n="admin.settings.notifyNewUserDesc">Email admins when new user registers</div>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" id="settingNotifyNewUser" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="setting-item">
                                <div>
                                    <div class="setting-label" data-i18n="admin.settings.notifyLocked">Notify on Account Lock</div>
                                    <div class="setting-description" data-i18n="admin.settings.notifyLockedDesc">Email admins when account is locked</div>
                                </div>
                                <label class="toggle">
                                    <input type="checkbox" id="settingNotifyLocked" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- User Details Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="admin.modal.userDetails">User Details</h3>
                <button class="modal-close" id="closeUserModal">&times;</button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeUserModalBtn" data-i18n="admin.close">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Action Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmModalTitle">Confirm Action</h3>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage">Are you sure you want to perform this action?</p>
                <div class="form-group mt-2 hidden" id="confirmReasonGroup">
                    <label class="form-label" data-i18n="admin.modal.reason">Reason (optional)</label>
                    <input type="text" class="form-input" id="confirmReason" placeholder="Enter reason...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelConfirmBtn" data-i18n="admin.cancel">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn" data-i18n="admin.confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Role Change Modal -->
    <div class="modal-overlay" id="roleModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="admin.modal.changeRole">Change Role</h3>
                <button class="modal-close" id="closeRoleModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="roleModalMessage">Select new role for user:</p>
                <div class="form-group mt-2">
                    <label class="form-label" data-i18n="admin.modal.newRole">New Role</label>
                    <select class="form-input" id="newRoleSelect">
                        <option value="viewer">Viewer</option>
                        <option value="auditor">Auditor</option>
                        <option value="admin">Admin</option>
                        <option value="super_admin">Super Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRoleBtn" data-i18n="admin.cancel">Cancel</button>
                <button class="btn btn-primary" id="confirmRoleBtn" data-i18n="admin.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Extend Expiry Modal -->
    <div class="modal-overlay" id="extendModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="admin.modal.extendExpiry">Extend Account Expiry</h3>
                <button class="modal-close" id="closeExtendModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="extendModalMessage">Extend account expiry by:</p>
                <div class="form-group mt-2">
                    <label class="form-label" data-i18n="admin.modal.days">Days</label>
                    <input type="number" class="form-input" id="extendDays" value="365" min="1" max="3650">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExtendBtn" data-i18n="admin.cancel">Cancel</button>
                <button class="btn btn-primary" id="confirmExtendBtn" data-i18n="admin.extend">Extend</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/i18n.js"></script>
    <script src="js/auth-client.js"></script>
    <script>
        // =============================================================================
        // Admin Panel Application
        // =============================================================================

        const AdminApp = {
            currentUser: null,
            users: [],
            pendingUsers: [],
            auditLog: [],
            currentPage: 1,
            pageSize: 10,
            totalUsers: 0,
            auditPage: 1,
            selectedUserId: null,
            confirmCallback: null,

            // Initialize
            async init() {
                try {
                    // Check authentication
                    if (!authApi.isAuthenticated()) {
                        window.location.href = '/login?redirect=/admin';
                        return;
                    }

                    // Load current user
                    await this.loadCurrentUser();

                    // Check admin permission
                    if (!['super_admin', 'admin'].includes(this.currentUser.role)) {
                        showAlert('error', { en: 'Access denied. Admin privileges required.', it: 'Accesso negato. Privilegi admin richiesti.' });
                        setTimeout(() => window.location.href = '/', 2000);
                        return;
                    }

                    // Initialize i18n
                    initI18n();

                    // Setup event listeners
                    this.setupEventListeners();

                    // Load initial data
                    await Promise.all([
                        this.loadUsers(),
                        this.loadPendingApprovals(),
                        this.loadStats()
                    ]);

                    // Hide super admin elements if not super admin
                    if (this.currentUser.role !== 'super_admin') {
                        document.querySelectorAll('.super-admin-only').forEach(el => {
                            el.style.display = 'none';
                        });
                    }

                    // Hide loading overlay
                    document.getElementById('loadingOverlay').style.display = 'none';

                } catch (error) {
                    console.error('Init error:', error);
                    handleApiError(error);
                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            },

            // Load current user
            async loadCurrentUser() {
                const response = await authApi.getMe();
                this.currentUser = response.user;

                // Update sidebar user info
                const initials = (this.currentUser.first_name?.[0] || '') + (this.currentUser.last_name?.[0] || '');
                document.getElementById('userAvatar').textContent = initials.toUpperCase() || '??';
                document.getElementById('userName').textContent = `${this.currentUser.first_name || ''} ${this.currentUser.last_name || ''}`.trim() || this.currentUser.email;
                document.getElementById('userRole').textContent = this.currentUser.role.replace('_', ' ');
            },

            // Load stats
            async loadStats() {
                try {
                    const response = await adminApi.getUsers({ limit: 1 });
                    // These would come from a dedicated stats endpoint in production
                    document.getElementById('statTotalUsers').textContent = response.total || '--';

                    const activeResponse = await adminApi.getUsers({ status: 'active', limit: 1 });
                    document.getElementById('statActiveUsers').textContent = activeResponse.total || '--';

                    const lockedResponse = await adminApi.getUsers({ status: 'locked', limit: 1 });
                    document.getElementById('statLockedUsers').textContent = lockedResponse.total || '--';

                    document.getElementById('statPendingUsers').textContent = this.pendingUsers.length;
                } catch (error) {
                    console.error('Stats error:', error);
                }
            },

            // Load users
            async loadUsers() {
                try {
                    const search = document.getElementById('searchInput').value;
                    const status = document.getElementById('statusFilter').value;
                    const role = document.getElementById('roleFilter').value;

                    const response = await adminApi.getUsers({
                        page: this.currentPage,
                        limit: this.pageSize,
                        search,
                        status,
                        role
                    });

                    this.users = response.users || [];
                    this.totalUsers = response.total || 0;
                    this.renderUsersTable();
                    this.updatePagination();
                } catch (error) {
                    console.error('Load users error:', error);
                    handleApiError(error);
                }
            },

            // Load pending approvals
            async loadPendingApprovals() {
                try {
                    const response = await adminApi.getPendingApprovals();
                    this.pendingUsers = response.users || [];
                    this.renderPendingList();

                    // Update badge
                    const badge = document.getElementById('pendingBadge');
                    if (this.pendingUsers.length > 0) {
                        badge.textContent = this.pendingUsers.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Load pending error:', error);
                }
            },

            // Load audit log
            async loadAuditLog() {
                try {
                    const action = document.getElementById('auditActionFilter').value;
                    const response = await adminApi.getAuditLog({
                        page: this.auditPage,
                        limit: 20,
                        action
                    });

                    this.auditLog = response.entries || [];
                    this.renderAuditLog();
                } catch (error) {
                    console.error('Load audit error:', error);
                }
            },

            // Render users table
            renderUsersTable() {
                const tbody = document.getElementById('usersTableBody');

                if (this.users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted" style="padding: 40px;">
                                ${getText('admin.noUsers') || 'No users found'}
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.users.map(user => `
                    <tr data-user-id="${user.id}">
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${this.getInitials(user)}</div>
                                <div class="user-info-cell">
                                    <span class="user-name">${this.escapeHtml(user.first_name || '')} ${this.escapeHtml(user.last_name || '')}</span>
                                    <span class="user-email">${this.escapeHtml(user.email)}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge role-${user.role}">${user.role.replace('_', ' ')}</span>
                        </td>
                        <td>
                            <span class="badge status-${user.status}">${this.formatStatus(user.status)}</span>
                        </td>
                        <td>
                            <span class="text-small">${user.last_login_at ? this.formatDate(user.last_login_at) : '--'}</span>
                        </td>
                        <td>
                            <span class="text-small ${this.isExpiringSoon(user.expires_at) ? 'text-warning' : ''}">${user.expires_at ? this.formatDate(user.expires_at) : 'Never'}</span>
                        </td>
                        <td>
                            <div class="actions-dropdown">
                                <button class="actions-btn" onclick="AdminApp.toggleActionsMenu(event, '${user.id}')">
                                    Actions ‚ñº
                                </button>
                                <div class="actions-menu" id="actions-${user.id}">
                                    <button class="actions-menu-item" onclick="AdminApp.viewUser('${user.id}')">
                                        üëÅÔ∏è ${getText('admin.view') || 'View'}
                                    </button>
                                    <button class="actions-menu-item" onclick="AdminApp.showRoleModal('${user.id}')">
                                        üîë ${getText('admin.changeRole') || 'Change Role'}
                                    </button>
                                    <button class="actions-menu-item" onclick="AdminApp.showExtendModal('${user.id}')">
                                        üìÖ ${getText('admin.extend') || 'Extend'}
                                    </button>
                                    <div class="actions-menu-divider"></div>
                                    ${user.status === 'locked' ? `
                                        <button class="actions-menu-item" onclick="AdminApp.unlockUser('${user.id}')">
                                            üîì ${getText('admin.unlock') || 'Unlock'}
                                        </button>
                                    ` : `
                                        <button class="actions-menu-item" onclick="AdminApp.lockUser('${user.id}')">
                                            üîí ${getText('admin.lock') || 'Lock'}
                                        </button>
                                    `}
                                    ${user.status === 'suspended' ? `
                                        <button class="actions-menu-item" onclick="AdminApp.activateUser('${user.id}')">
                                            ‚úÖ ${getText('admin.activate') || 'Activate'}
                                        </button>
                                    ` : `
                                        <button class="actions-menu-item" onclick="AdminApp.suspendUser('${user.id}')">
                                            ‚è∏Ô∏è ${getText('admin.suspend') || 'Suspend'}
                                        </button>
                                    `}
                                    <div class="actions-menu-divider"></div>
                                    <button class="actions-menu-item danger" onclick="AdminApp.deleteUser('${user.id}')">
                                        üóëÔ∏è ${getText('admin.delete') || 'Delete'}
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `).join('');
            },

            // Render pending list
            renderPendingList() {
                const container = document.getElementById('pendingList');
                const emptyState = document.getElementById('pendingEmpty');

                if (this.pendingUsers.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>${getText('admin.table.user') || 'User'}</th>
                                <th>${getText('admin.table.registeredAt') || 'Registered'}</th>
                                <th>${getText('admin.table.actions') || 'Actions'}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.pendingUsers.map(user => `
                                <tr>
                                    <td>
                                        <div class="user-cell">
                                            <div class="user-avatar">${this.getInitials(user)}</div>
                                            <div class="user-info-cell">
                                                <span class="user-name">${this.escapeHtml(user.first_name || '')} ${this.escapeHtml(user.last_name || '')}</span>
                                                <span class="user-email">${this.escapeHtml(user.email)}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-small">${this.formatDate(user.created_at)}</span>
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button class="btn btn-primary btn-sm" onclick="AdminApp.approveUser('${user.id}')">
                                                ‚úì ${getText('admin.approve') || 'Approve'}
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="AdminApp.rejectUser('${user.id}')">
                                                ‚úó ${getText('admin.reject') || 'Reject'}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            },

            // Render audit log
            renderAuditLog() {
                const container = document.getElementById('auditList');
                const emptyState = document.getElementById('auditEmpty');

                if (this.auditLog.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                container.innerHTML = this.auditLog.map(entry => `
                    <div class="audit-entry">
                        <div class="audit-icon ${this.getAuditIconClass(entry.action)}">
                            ${this.getAuditIcon(entry.action)}
                        </div>
                        <div class="audit-content">
                            <div class="audit-action">${this.formatAuditAction(entry.action)}</div>
                            <div class="audit-details">
                                ${entry.user_email || 'Unknown user'}
                                ${entry.target_user_email ? `‚Üí ${entry.target_user_email}` : ''}
                                ${entry.details ? `<br><small>${this.escapeHtml(JSON.stringify(entry.details))}</small>` : ''}
                            </div>
                            <div class="audit-meta">
                                ${this.formatDate(entry.created_at)} ‚Ä¢ IP: ${entry.ip_address || 'Unknown'}
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            // Update pagination
            updatePagination() {
                const totalPages = Math.ceil(this.totalUsers / this.pageSize);
                const start = (this.currentPage - 1) * this.pageSize + 1;
                const end = Math.min(this.currentPage * this.pageSize, this.totalUsers);

                document.getElementById('paginationInfo').textContent =
                    `Showing ${start}-${end} of ${this.totalUsers} users`;

                document.getElementById('prevPageBtn').disabled = this.currentPage <= 1;
                document.getElementById('nextPageBtn').disabled = this.currentPage >= totalPages;
            },

            // Setup event listeners
            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showSection(item.dataset.section);
                    });
                });

                // Mobile menu
                document.getElementById('mobileMenuToggle').addEventListener('click', () => {
                    document.getElementById('adminSidebar').classList.toggle('open');
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    await authApi.logout();
                    window.location.href = '/login';
                });

                // Search and filters
                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.currentPage = 1;
                        this.loadUsers();
                    }, 300);
                });

                document.getElementById('statusFilter').addEventListener('change', () => {
                    this.currentPage = 1;
                    this.loadUsers();
                });

                document.getElementById('roleFilter').addEventListener('change', () => {
                    this.currentPage = 1;
                    this.loadUsers();
                });

                // Pagination
                document.getElementById('prevPageBtn').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.loadUsers();
                    }
                });

                document.getElementById('nextPageBtn').addEventListener('click', () => {
                    this.currentPage++;
                    this.loadUsers();
                });

                // Refresh buttons
                document.getElementById('refreshUsersBtn').addEventListener('click', () => this.loadUsers());
                document.getElementById('refreshPendingBtn').addEventListener('click', () => this.loadPendingApprovals());
                document.getElementById('refreshAuditBtn').addEventListener('click', () => this.loadAuditLog());

                // Audit filter
                document.getElementById('auditActionFilter').addEventListener('change', () => {
                    this.auditPage = 1;
                    this.loadAuditLog();
                });

                // Modals
                document.getElementById('closeUserModal').addEventListener('click', () => this.closeModal('userModal'));
                document.getElementById('closeUserModalBtn').addEventListener('click', () => this.closeModal('userModal'));

                document.getElementById('closeConfirmModal').addEventListener('click', () => this.closeModal('confirmModal'));
                document.getElementById('cancelConfirmBtn').addEventListener('click', () => this.closeModal('confirmModal'));
                document.getElementById('confirmActionBtn').addEventListener('click', () => {
                    if (this.confirmCallback) {
                        const reason = document.getElementById('confirmReason').value;
                        this.confirmCallback(reason);
                    }
                    this.closeModal('confirmModal');
                });

                document.getElementById('closeRoleModal').addEventListener('click', () => this.closeModal('roleModal'));
                document.getElementById('cancelRoleBtn').addEventListener('click', () => this.closeModal('roleModal'));
                document.getElementById('confirmRoleBtn').addEventListener('click', () => this.confirmRoleChange());

                document.getElementById('closeExtendModal').addEventListener('click', () => this.closeModal('extendModal'));
                document.getElementById('cancelExtendBtn').addEventListener('click', () => this.closeModal('extendModal'));
                document.getElementById('confirmExtendBtn').addEventListener('click', () => this.confirmExtend());

                // Settings
                document.getElementById('saveSettingsBtn').addEventListener('click', () => this.saveSettings());

                // Close menus on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.actions-dropdown')) {
                        document.querySelectorAll('.actions-menu.show').forEach(menu => {
                            menu.classList.remove('show');
                        });
                    }
                });
            },

            // Show section
            showSection(section) {
                // Update nav
                document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                    item.classList.toggle('active', item.dataset.section === section);
                });

                // Show content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${section}Section`).classList.add('active');

                // Load data if needed
                if (section === 'audit' && this.auditLog.length === 0) {
                    this.loadAuditLog();
                }
                if (section === 'settings') {
                    this.loadSettings();
                }

                // Close mobile menu
                document.getElementById('adminSidebar').classList.remove('open');
            },

            // Toggle actions menu
            toggleActionsMenu(event, userId) {
                event.stopPropagation();
                const menu = document.getElementById(`actions-${userId}`);

                // Close other menus
                document.querySelectorAll('.actions-menu.show').forEach(m => {
                    if (m !== menu) m.classList.remove('show');
                });

                menu.classList.toggle('show');
            },

            // User actions
            async viewUser(userId) {
                try {
                    const response = await adminApi.getUser(userId);
                    const user = response.user;

                    document.getElementById('userModalBody').innerHTML = `
                        <div class="user-cell mb-2" style="justify-content: center;">
                            <div class="user-avatar" style="width: 60px; height: 60px; font-size: 24px;">
                                ${this.getInitials(user)}
                            </div>
                        </div>
                        <div class="text-center mb-3">
                            <h3>${this.escapeHtml(user.first_name || '')} ${this.escapeHtml(user.last_name || '')}</h3>
                            <p class="text-muted">${this.escapeHtml(user.email)}</p>
                            <span class="badge role-${user.role}">${user.role.replace('_', ' ')}</span>
                            <span class="badge status-${user.status}">${this.formatStatus(user.status)}</span>
                        </div>
                        <table class="table">
                            <tr><td><strong>ID</strong></td><td>${user.id}</td></tr>
                            <tr><td><strong>Created</strong></td><td>${this.formatDate(user.created_at)}</td></tr>
                            <tr><td><strong>Last Login</strong></td><td>${user.last_login_at ? this.formatDate(user.last_login_at) : 'Never'}</td></tr>
                            <tr><td><strong>Expires</strong></td><td>${user.expires_at ? this.formatDate(user.expires_at) : 'Never'}</td></tr>
                            <tr><td><strong>Email Verified</strong></td><td>${user.email_verified_at ? '‚úì Yes' : '‚úó No'}</td></tr>
                            <tr><td><strong>Failed Logins</strong></td><td>${user.failed_login_attempts || 0}</td></tr>
                        </table>
                    `;

                    this.showModal('userModal');
                } catch (error) {
                    handleApiError(error);
                }
            },

            async approveUser(userId) {
                try {
                    await adminApi.approveUser(userId);
                    showAlert('success', { en: 'User approved successfully', it: 'Utente approvato con successo' });
                    await Promise.all([this.loadPendingApprovals(), this.loadUsers(), this.loadStats()]);
                } catch (error) {
                    handleApiError(error);
                }
            },

            rejectUser(userId) {
                this.selectedUserId = userId;
                document.getElementById('confirmModalTitle').textContent = getText('admin.confirmReject') || 'Reject User';
                document.getElementById('confirmModalMessage').textContent = getText('admin.confirmRejectMessage') || 'Are you sure you want to reject this user?';
                document.getElementById('confirmReasonGroup').classList.remove('hidden');
                document.getElementById('confirmReason').value = '';

                this.confirmCallback = async (reason) => {
                    try {
                        await adminApi.rejectUser(this.selectedUserId, reason);
                        showAlert('success', { en: 'User rejected', it: 'Utente rifiutato' });
                        await this.loadPendingApprovals();
                    } catch (error) {
                        handleApiError(error);
                    }
                };

                this.showModal('confirmModal');
            },

            lockUser(userId) {
                this.selectedUserId = userId;
                document.getElementById('confirmModalTitle').textContent = getText('admin.confirmLock') || 'Lock User';
                document.getElementById('confirmModalMessage').textContent = getText('admin.confirmLockMessage') || 'Are you sure you want to lock this user?';
                document.getElementById('confirmReasonGroup').classList.remove('hidden');
                document.getElementById('confirmReason').value = '';

                this.confirmCallback = async (reason) => {
                    try {
                        await adminApi.lockUser(this.selectedUserId, null, reason);
                        showAlert('success', { en: 'User locked', it: 'Utente bloccato' });
                        await this.loadUsers();
                    } catch (error) {
                        handleApiError(error);
                    }
                };

                this.showModal('confirmModal');
            },

            async unlockUser(userId) {
                try {
                    await adminApi.unlockUser(userId);
                    showAlert('success', { en: 'User unlocked', it: 'Utente sbloccato' });
                    await this.loadUsers();
                } catch (error) {
                    handleApiError(error);
                }
            },

            suspendUser(userId) {
                this.selectedUserId = userId;
                document.getElementById('confirmModalTitle').textContent = getText('admin.confirmSuspend') || 'Suspend User';
                document.getElementById('confirmModalMessage').textContent = getText('admin.confirmSuspendMessage') || 'Are you sure you want to suspend this user?';
                document.getElementById('confirmReasonGroup').classList.remove('hidden');
                document.getElementById('confirmReason').value = '';

                this.confirmCallback = async (reason) => {
                    try {
                        await adminApi.suspendUser(this.selectedUserId, reason);
                        showAlert('success', { en: 'User suspended', it: 'Utente sospeso' });
                        await this.loadUsers();
                    } catch (error) {
                        handleApiError(error);
                    }
                };

                this.showModal('confirmModal');
            },

            async activateUser(userId) {
                try {
                    await adminApi.activateUser(userId);
                    showAlert('success', { en: 'User activated', it: 'Utente attivato' });
                    await this.loadUsers();
                } catch (error) {
                    handleApiError(error);
                }
            },

            deleteUser(userId) {
                this.selectedUserId = userId;
                document.getElementById('confirmModalTitle').textContent = getText('admin.confirmDelete') || 'Delete User';
                document.getElementById('confirmModalMessage').textContent = getText('admin.confirmDeleteMessage') || 'Are you sure you want to permanently delete this user? This action cannot be undone.';
                document.getElementById('confirmReasonGroup').classList.add('hidden');
                document.getElementById('confirmActionBtn').classList.add('btn-danger');

                this.confirmCallback = async () => {
                    try {
                        await adminApi.deleteUser(this.selectedUserId);
                        showAlert('success', { en: 'User deleted', it: 'Utente eliminato' });
                        await Promise.all([this.loadUsers(), this.loadStats()]);
                    } catch (error) {
                        handleApiError(error);
                    }
                };

                this.showModal('confirmModal');
            },

            showRoleModal(userId) {
                this.selectedUserId = userId;
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('newRoleSelect').value = user.role;
                }
                this.showModal('roleModal');
            },

            async confirmRoleChange() {
                const newRole = document.getElementById('newRoleSelect').value;
                try {
                    await adminApi.changeRole(this.selectedUserId, newRole);
                    showAlert('success', { en: 'Role updated', it: 'Ruolo aggiornato' });
                    this.closeModal('roleModal');
                    await this.loadUsers();
                } catch (error) {
                    handleApiError(error);
                }
            },

            showExtendModal(userId) {
                this.selectedUserId = userId;
                document.getElementById('extendDays').value = 365;
                this.showModal('extendModal');
            },

            async confirmExtend() {
                const days = parseInt(document.getElementById('extendDays').value);
                try {
                    await adminApi.extendExpiry(this.selectedUserId, days);
                    showAlert('success', { en: 'Expiry extended', it: 'Scadenza estesa' });
                    this.closeModal('extendModal');
                    await this.loadUsers();
                } catch (error) {
                    handleApiError(error);
                }
            },

            // Settings
            async loadSettings() {
                try {
                    const response = await adminApi.getSettings();
                    const settings = response.settings || {};

                    document.getElementById('settingAllowRegistration').checked = settings.allow_registration !== false;
                    document.getElementById('settingRequireApproval').checked = settings.require_approval !== false;
                    document.getElementById('settingRequireEmailVerification').checked = settings.require_email_verification !== false;
                    document.getElementById('settingDefaultRole').value = settings.default_role || 'viewer';
                    document.getElementById('settingMaxLoginAttempts').value = settings.max_login_attempts || 5;
                    document.getElementById('settingSessionTimeout').value = settings.session_timeout_hours || 24;
                    document.getElementById('settingPasswordExpiry').value = settings.password_expiry_days || 0;
                    document.getElementById('settingDefaultExpiry').value = settings.default_account_expiry_days || 365;
                    document.getElementById('settingExpiryWarning').value = settings.expiry_warning_days || 14;
                    document.getElementById('settingNotifyNewUser').checked = settings.notify_on_registration !== false;
                    document.getElementById('settingNotifyLocked').checked = settings.notify_on_lockout !== false;
                } catch (error) {
                    console.error('Load settings error:', error);
                }
            },

            async saveSettings() {
                try {
                    const settings = {
                        allow_registration: document.getElementById('settingAllowRegistration').checked,
                        require_approval: document.getElementById('settingRequireApproval').checked,
                        require_email_verification: document.getElementById('settingRequireEmailVerification').checked,
                        default_role: document.getElementById('settingDefaultRole').value,
                        max_login_attempts: parseInt(document.getElementById('settingMaxLoginAttempts').value),
                        session_timeout_hours: parseInt(document.getElementById('settingSessionTimeout').value),
                        password_expiry_days: parseInt(document.getElementById('settingPasswordExpiry').value),
                        default_account_expiry_days: parseInt(document.getElementById('settingDefaultExpiry').value),
                        expiry_warning_days: parseInt(document.getElementById('settingExpiryWarning').value),
                        notify_on_registration: document.getElementById('settingNotifyNewUser').checked,
                        notify_on_lockout: document.getElementById('settingNotifyLocked').checked
                    };

                    await adminApi.updateSettings(settings);
                    showAlert('success', { en: 'Settings saved successfully', it: 'Impostazioni salvate con successo' });
                } catch (error) {
                    handleApiError(error);
                }
            },

            // Modal helpers
            showModal(modalId) {
                document.getElementById(modalId).classList.add('show');
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
                this.confirmCallback = null;
            },

            // Utility functions
            getInitials(user) {
                return ((user.first_name?.[0] || '') + (user.last_name?.[0] || '')).toUpperCase() || '??';
            },

            escapeHtml(str) {
                if (!str) return '';
                return str.replace(/&/g, '&amp;')
                         .replace(/</g, '&lt;')
                         .replace(/>/g, '&gt;')
                         .replace(/"/g, '&quot;')
                         .replace(/'/g, '&#039;');
            },

            formatDate(dateStr) {
                if (!dateStr) return '--';
                const date = new Date(dateStr);
                return date.toLocaleDateString(getCurrentLanguage(), {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            formatStatus(status) {
                const statusMap = {
                    'active': getText('status.active') || 'Active',
                    'pending_verification': getText('status.pendingVerification') || 'Pending Verification',
                    'pending_approval': getText('status.pendingApproval') || 'Pending Approval',
                    'locked': getText('status.locked') || 'Locked',
                    'suspended': getText('status.suspended') || 'Suspended',
                    'expired': getText('status.expired') || 'Expired',
                    'deactivated': getText('status.deactivated') || 'Deactivated'
                };
                return statusMap[status] || status;
            },

            isExpiringSoon(dateStr) {
                if (!dateStr) return false;
                const days = (new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24);
                return days > 0 && days <= 30;
            },

            getAuditIcon(action) {
                const icons = {
                    'login': 'üîì',
                    'logout': 'üö™',
                    'login_failed': '‚ùå',
                    'password_reset': 'üîë',
                    'password_changed': 'üîê',
                    'user_created': 'üë§',
                    'user_approved': '‚úÖ',
                    'user_rejected': '‚ùå',
                    'user_locked': 'üîí',
                    'user_unlocked': 'üîì',
                    'user_suspended': '‚è∏Ô∏è',
                    'user_activated': '‚ñ∂Ô∏è',
                    'user_deleted': 'üóëÔ∏è',
                    'role_changed': 'üîë',
                    'settings_updated': '‚öôÔ∏è'
                };
                return icons[action] || 'üìã';
            },

            getAuditIconClass(action) {
                if (['login', 'user_approved', 'user_activated', 'user_unlocked'].includes(action)) return 'login';
                if (['logout'].includes(action)) return 'logout';
                if (['login_failed', 'user_rejected', 'user_locked', 'user_suspended', 'user_deleted'].includes(action)) return 'failed';
                if (['password_reset', 'password_changed', 'role_changed', 'settings_updated'].includes(action)) return 'change';
                return 'admin';
            },

            formatAuditAction(action) {
                return action.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            }
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => AdminApp.init());
    </script>
</body>
</html>
