#!/bin/bash

# CPF Dashboard Launcher for macOS
# Simplified version with full path support

# Set PATH immediately
export PATH="/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:$PATH"

# Log file for debugging
LOG_FILE="$HOME/.cpf_launcher.log"
echo "=== CPF Launcher started at $(/bin/date) ===" > "$LOG_FILE"

# Configuration file
CONFIG_FILE="$HOME/.cpf_dashboard_path"

# Find dashboard directory
DASHBOARD_DIR=""

if [[ -f "$CONFIG_FILE" ]]; then
    DASHBOARD_DIR=$(/bin/cat "$CONFIG_FILE")
    echo "Using saved path: $DASHBOARD_DIR" >> "$LOG_FILE"
fi

if [[ -z "$DASHBOARD_DIR" ]] || [[ ! -f "$DASHBOARD_DIR/start.sh" ]]; then
    # Auto-detect
    for DIR in \
        "$HOME/CPF/dashboard" \
        "$HOME/Desktop/CPF/dashboard" \
        "$HOME/Documents/CPF/dashboard" \
        "$HOME/Projects/CPF/dashboard" \
        "$HOME/Lavori/"*"/CPF/dashboard" \
        "$HOME/Lavori/"*"/github/CPF/dashboard"; do
        if [[ -f "$DIR/start.sh" ]]; then
            DASHBOARD_DIR="$DIR"
            echo "Auto-detected: $DASHBOARD_DIR" >> "$LOG_FILE"
            break
        fi
    done
fi

# If still not found, ask user
if [[ -z "$DASHBOARD_DIR" ]] || [[ ! -f "$DASHBOARD_DIR/start.sh" ]]; then
    DASHBOARD_DIR=$(/usr/bin/osascript -e 'POSIX path of (choose folder with prompt "Select the CPF dashboard folder:")' 2>/dev/null)
    DASHBOARD_DIR="${DASHBOARD_DIR%/}"
    echo "User selected: $DASHBOARD_DIR" >> "$LOG_FILE"
fi

# Verify
if [[ ! -f "$DASHBOARD_DIR/start.sh" ]]; then
    /usr/bin/osascript -e 'display alert "Error" message "start.sh not found"'
    echo "ERROR: start.sh not found in $DASHBOARD_DIR" >> "$LOG_FILE"
    exit 1
fi

# Save path
echo "$DASHBOARD_DIR" > "$CONFIG_FILE"

# Find npm
NPM_BIN=""
if [[ -d "$HOME/.nvm/versions/node" ]]; then
    NPM_BIN=$(/bin/ls -1d "$HOME/.nvm/versions/node/"*/bin 2>/dev/null | /usr/bin/tail -1)
fi
if [[ -z "$NPM_BIN" ]] && [[ -x "/opt/homebrew/bin/npm" ]]; then
    NPM_BIN="/opt/homebrew/bin"
fi
if [[ -z "$NPM_BIN" ]] && [[ -x "/usr/local/bin/npm" ]]; then
    NPM_BIN="/usr/local/bin"
fi

echo "NPM_BIN: $NPM_BIN" >> "$LOG_FILE"

# Kill existing server on port 3000
EXISTING_PID=$(/usr/bin/lsof -ti:3000 2>/dev/null | /usr/bin/head -1)
if [[ -n "$EXISTING_PID" ]]; then
    echo "Killing existing server PID: $EXISTING_PID" >> "$LOG_FILE"
    /bin/kill -9 $EXISTING_PID 2>/dev/null
    /bin/sleep 2
fi

# Launch Terminal with the server
echo "Launching Terminal..." >> "$LOG_FILE"
/usr/bin/osascript -e "
tell application \"Terminal\"
    activate
    do script \"cd '$DASHBOARD_DIR' && export PATH='$NPM_BIN:/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:\$PATH' && /bin/bash start.sh\"
end tell
"

echo "Terminal launched, entering wait loop..." >> "$LOG_FILE"

# Keep app running in Dock
while true; do
    /bin/sleep 3600
done
