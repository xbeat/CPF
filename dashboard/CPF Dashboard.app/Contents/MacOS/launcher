#!/bin/bash

# CPF Dashboard Launcher for macOS
# This script finds and executes start.sh in a Terminal window

# Configuration file for storing dashboard path
CONFIG_FILE="$HOME/.cpf_dashboard_path"

# Find the dashboard directory
DASHBOARD_DIR=""

# First check if we have a saved path
if [[ -f "$CONFIG_FILE" ]]; then
    SAVED_PATH=$(cat "$CONFIG_FILE")
    if [[ -f "$SAVED_PATH/start.sh" ]]; then
        DASHBOARD_DIR="$SAVED_PATH"
    fi
fi

# If no saved path, try to auto-detect
if [[ -z "$DASHBOARD_DIR" ]]; then
    # Get the directory where the .app bundle is located
    APP_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
    PARENT_DIR="$(dirname "$APP_DIR")"

    if [[ -f "$PARENT_DIR/start.sh" ]]; then
        DASHBOARD_DIR="$PARENT_DIR"
    elif [[ -f "$HOME/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/CPF/dashboard"
    elif [[ -f "$HOME/Desktop/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/Desktop/CPF/dashboard"
    elif [[ -f "$HOME/Documents/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/Documents/CPF/dashboard"
    elif [[ -f "$HOME/Projects/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/Projects/CPF/dashboard"
    else
        # Ask user to select the folder
        SELECTED_PATH=$(osascript -e 'tell application "System Events"' \
            -e 'activate' \
            -e 'set folderPath to POSIX path of (choose folder with prompt "Select the CPF dashboard folder (containing start.sh):")' \
            -e 'end tell' 2>/dev/null)

        if [[ -n "$SELECTED_PATH" && -f "${SELECTED_PATH%/}/start.sh" ]]; then
            DASHBOARD_DIR="${SELECTED_PATH%/}"
        else
            osascript -e 'display alert "CPF Dashboard Error" message "The selected folder does not contain start.sh. Please select the correct dashboard folder." as critical'
            exit 1
        fi
    fi

    # Save the path for next time
    if [[ -n "$DASHBOARD_DIR" ]]; then
        echo "$DASHBOARD_DIR" > "$CONFIG_FILE"
    fi
fi

# Verify start.sh exists
if [[ ! -f "$DASHBOARD_DIR/start.sh" ]]; then
    rm -f "$CONFIG_FILE"
    osascript -e "display alert \"CPF Dashboard Error\" message \"Cannot find start.sh. Please delete ~/.cpf_dashboard_path and restart.\" as critical"
    exit 1
fi

# Kill any existing instance on port 3000
/usr/bin/lsof -ti:3000 2>/dev/null | /usr/bin/xargs kill -9 2>/dev/null || true

# Detect npm path - check common locations
NPM_PATH=""
for p in /usr/local/bin/npm /opt/homebrew/bin/npm "$HOME/.nvm/versions/node/"*/bin/npm; do
    if [[ -x "$p" ]]; then
        NPM_PATH="$(dirname "$p")"
        break
    fi
done

# Open Terminal and run start.sh
osascript <<EOF
tell application "Terminal"
    activate
    do script "cd '$DASHBOARD_DIR' && export PATH='$NPM_PATH:/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:\$PATH' && if [ ! -d node_modules ]; then npm install; fi && /bin/bash start.sh"
end tell
EOF

# Keep this process alive so the app stays in the Dock
# Press Cmd+Q on the app icon to quit, or close the Terminal window
# Use caffeinate to prevent the app from being terminated
exec /usr/bin/caffeinate -i -w $$
