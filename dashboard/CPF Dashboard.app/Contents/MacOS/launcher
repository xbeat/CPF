#!/bin/bash

# CPF Dashboard Launcher for macOS
# This script finds and executes start.sh in a Terminal window

# Load user's shell environment to get correct PATH
if [[ -f "$HOME/.zshrc" ]]; then
    source "$HOME/.zshrc" 2>/dev/null
elif [[ -f "$HOME/.bash_profile" ]]; then
    source "$HOME/.bash_profile" 2>/dev/null
elif [[ -f "$HOME/.bashrc" ]]; then
    source "$HOME/.bashrc" 2>/dev/null
fi

# Also check common Node.js installation paths
export PATH="/usr/local/bin:/opt/homebrew/bin:$HOME/.nvm/versions/node/$(ls -1 $HOME/.nvm/versions/node 2>/dev/null | tail -1)/bin:$PATH"

# Configuration file for storing dashboard path
CONFIG_FILE="$HOME/.cpf_dashboard_path"

# Get the directory where the .app bundle is located
APP_DIR="$(dirname "$(dirname "$(dirname "$0")")")"

# Find the dashboard directory
DASHBOARD_DIR=""

# First check if we have a saved path
if [[ -f "$CONFIG_FILE" ]]; then
    SAVED_PATH=$(cat "$CONFIG_FILE")
    if [[ -f "$SAVED_PATH/start.sh" ]]; then
        DASHBOARD_DIR="$SAVED_PATH"
    fi
fi

# If no saved path, try to auto-detect
if [[ -z "$DASHBOARD_DIR" ]]; then
    # Check if app is inside the dashboard folder
    PARENT_DIR="$(dirname "$APP_DIR")"
    if [[ -f "$PARENT_DIR/start.sh" ]]; then
        DASHBOARD_DIR="$PARENT_DIR"
    # Check common locations
    elif [[ -f "$HOME/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/CPF/dashboard"
    elif [[ -f "$HOME/Desktop/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/Desktop/CPF/dashboard"
    elif [[ -f "$HOME/Documents/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/Documents/CPF/dashboard"
    elif [[ -f "$HOME/Projects/CPF/dashboard/start.sh" ]]; then
        DASHBOARD_DIR="$HOME/Projects/CPF/dashboard"
    else
        # Ask user to select the folder
        SELECTED_PATH=$(osascript -e 'tell application "System Events"' \
            -e 'activate' \
            -e 'set folderPath to POSIX path of (choose folder with prompt "Select the CPF dashboard folder (containing start.sh):")' \
            -e 'end tell' 2>/dev/null)

        if [[ -n "$SELECTED_PATH" && -f "$SELECTED_PATH/start.sh" ]]; then
            DASHBOARD_DIR="$SELECTED_PATH"
            # Remove trailing slash if present
            DASHBOARD_DIR="${DASHBOARD_DIR%/}"
        else
            osascript -e 'display alert "CPF Dashboard Error" message "The selected folder does not contain start.sh. Please select the correct dashboard folder." as critical'
            exit 1
        fi
    fi

    # Save the path for next time
    if [[ -n "$DASHBOARD_DIR" ]]; then
        echo "$DASHBOARD_DIR" > "$CONFIG_FILE"
    fi
fi

# Verify start.sh exists
if [[ ! -f "$DASHBOARD_DIR/start.sh" ]]; then
    # Clear saved path if invalid
    rm -f "$CONFIG_FILE"
    osascript -e "display alert \"CPF Dashboard Error\" message \"Cannot find start.sh in $DASHBOARD_DIR. Please restart the app to select the correct folder.\" as critical"
    exit 1
fi

# Check if Node.js is installed
if ! command -v node &> /dev/null; then
    osascript -e 'display alert "Node.js Not Found" message "Please install Node.js from https://nodejs.org" as critical'
    exit 1
fi

# Check if npm is installed
if ! command -v npm &> /dev/null; then
    osascript -e 'display alert "npm Not Found" message "Please install Node.js (includes npm) from https://nodejs.org" as critical'
    exit 1
fi

# Kill any existing instance on port 3000
lsof -ti:3000 | xargs kill -9 2>/dev/null || true

# Open Terminal and run start.sh
osascript <<EOF
tell application "Terminal"
    activate
    do script "cd '$DASHBOARD_DIR' && if [ ! -d node_modules ]; then npm install; fi && bash start.sh"
end tell
EOF

# Wait a moment for the server to start
sleep 3

# Keep the app running while server is running on port 3000
# This makes the app stay in the Dock
while lsof -ti:3000 > /dev/null 2>&1; do
    sleep 2
done
