<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPF Auditing Dashboard - Progress & Risk Analysis</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Enhanced auditing dashboard styles */
        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .org-progress {
            margin-bottom: 30px;
        }

        .org-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .org-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .org-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar-large {
            width: 100%;
            height: 40px;
            background: var(--border);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }

        .progress-fill-large {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #27ae60);
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .category-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-progress-item {
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
        }

        .category-name-small {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text);
            margin-bottom: 8px;
        }

        .category-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .category-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #27ae60);
            transition: width 0.4s ease;
        }

        .category-stat {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 5px;
        }

        .indicator-completion-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px;
            margin-top: 15px;
        }

        .indicator-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .indicator-cell.completed {
            background: var(--success);
            color: white;
        }

        .indicator-cell.missing {
            background: #e0e0e0;
            color: #999;
        }

        .indicator-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .missing-list {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .missing-title {
            font-size: 13px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }

        .missing-indicators {
            font-size: 12px;
            color: #856404;
            line-height: 1.8;
        }

        .overall-summary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 13px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>üìã CPF Auditing Dashboard</h1>
            <p class="subtitle">Field Kit Progress Tracking + Bayesian Risk Analysis</p>
        </header>

        <!-- Main Content -->
        <div class="dashboard-main">
            <!-- Sidebar: Organizations List -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>Organizations</h2>
                    <span id="org-count" class="badge">0</span>
                </div>
                <div id="org-list" class="org-list">
                    <!-- Populated by JS -->
                </div>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <!-- Loading State -->
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading auditing data...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <h2>üëã Welcome to CPF Auditing Dashboard</h2>
                    <p>Select an organization from the sidebar to view progress and risk analysis</p>
                </div>

                <!-- Organization Detail View -->
                <div id="org-detail" class="org-detail" style="display: none;">
                    <!-- Tabs -->
                    <div class="dashboard-tabs">
                        <button class="tab active" onclick="switchTab('progress')">üìä Progress Tracking</button>
                        <button class="tab" onclick="switchTab('analysis')">üî¨ Risk Analysis</button>
                    </div>

                    <!-- TAB 1: Progress Tracking -->
                    <div id="tab-progress" class="tab-content active">
                        <div class="progress-container">
                            <div class="org-progress">
                                <div class="org-header">
                                    <div class="org-title" id="progress-org-name">Organization</div>
                                    <div class="org-stats">
                                        <div class="stat">
                                            <span class="stat-label">Completed</span>
                                            <span class="stat-value" id="progress-completed">0/100</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-label">Coverage</span>
                                            <span class="stat-value" id="progress-percentage">0%</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="progress-bar-large">
                                    <div class="progress-fill-large" id="progress-bar" style="width: 0%">0%</div>
                                </div>

                                <h4 style="margin: 20px 0 10px 0; font-size: 14px; color: var(--text-light);">Category Progress</h4>
                                <div class="category-progress-grid" id="category-progress-grid">
                                    <!-- Populated by JS -->
                                </div>

                                <h4 style="margin: 20px 0 10px 0; font-size: 14px; color: var(--text-light);">Indicator Completion Grid (100 total)</h4>
                                <div class="indicator-completion-grid" id="indicator-completion-grid">
                                    <!-- Populated by JS -->
                                </div>

                                <div id="missing-indicators-container">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: Risk Analysis (Bayesian) -->
                    <div id="tab-analysis" class="tab-content">
                        <!-- Overall Risk Card -->
                        <div class="risk-card">
                            <div class="risk-score-section">
                                <div class="risk-label">Overall Organizational Risk</div>
                                <div class="risk-value" id="overall-risk-value">0%</div>
                                <div class="risk-bar-container">
                                    <div class="risk-bar-fill" id="overall-risk-bar"></div>
                                </div>
                            </div>
                            <div class="risk-metadata">
                                <div class="meta-item">
                                    <span class="meta-label">Confidence</span>
                                    <span class="meta-value" id="confidence-value">0%</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Trend</span>
                                    <span class="meta-value trend" id="trend-value">-</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Last Updated</span>
                                    <span class="meta-value" id="last-updated">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Category Heatmap -->
                        <section class="section">
                            <h3 class="section-title">üìä Risk by Category</h3>
                            <div id="category-heatmap" class="category-heatmap">
                                <!-- Populated by JS -->
                            </div>
                        </section>

                        <!-- Prioritization Table -->
                        <section class="section">
                            <h3 class="section-title">üéØ Prioritization Matrix</h3>
                            <p class="section-desc">Categories ordered by priority for remediation (risk √ó weight + downstream impact)</p>
                            <div class="table-container">
                                <table id="prioritization-table" class="prioritization-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Category</th>
                                            <th>Risk</th>
                                            <th>Confidence</th>
                                            <th>Priority Score</th>
                                            <th>Downstream Impact</th>
                                            <th>Recommendation</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <!-- SOC vs Human Convergence -->
                        <section class="section">
                            <h3 class="section-title">üîó SOC vs Human Convergence</h3>
                            <p class="section-desc">Comparison of machine (SOC) and human (auditor) assessments</p>
                            <div id="convergence-chart" class="convergence-chart">
                                <canvas id="convergence-canvas"></canvas>
                            </div>
                        </section>

                        <!-- Indicator Grid (100 tiles) -->
                        <section class="section">
                            <h3 class="section-title">üîç Indicator Matrix (100 Indicators)</h3>
                            <p class="section-desc">Click any indicator for detailed breakdown</p>
                            <div id="indicator-grid" class="indicator-grid">
                                <!-- Populated by JS: 10x10 grid -->
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Indicator Detail Modal -->
    <div id="indicator-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeIndicatorModal()">&times;</span>
            <h2 id="modal-indicator-title">Indicator X.Y</h2>
            <div id="modal-indicator-body">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="bayesian.js"></script>
    <script src="visualizations.js"></script>
    <script>
        // Global state
        let auditingData = null;
        let organizationsData = null;
        let currentOrgId = null;

        // Load data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
        });

        async function loadAllData() {
            try {
                // Load both auditing results and organizations data
                const [auditingResp, orgsResp] = await Promise.all([
                    fetch('/api/auditing-results'),
                    fetch('/api/organizations')
                ]);

                if (!auditingResp.ok || !orgsResp.ok) {
                    throw new Error('Failed to load data. Run batch import first.');
                }

                auditingData = await auditingResp.json();
                organizationsData = await orgsResp.json();

                document.getElementById('loading').style.display = 'none';
                renderOrganizationsList();
                document.getElementById('empty-state').style.display = 'block';

            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <h2>‚ö†Ô∏è No Auditing Data Found</h2>
                    <p>${error.message}</p>
                    <p>To generate data:</p>
                    <ol style="text-align: left; margin: 20px auto; max-width: 600px;">
                        <li>Generate synthetic Field Kit exports:<br>
                            <code style="background: #f5f5f5; padding: 5px;">POST /api/generate-synthetic</code>
                        </li>
                        <li>Run batch import:<br>
                            <code style="background: #f5f5f5; padding: 5px;">POST /api/batch-import</code>
                        </li>
                        <li>Or use the Field Kit Client to create assessments</li>
                    </ol>
                `;
            }
        }

        function renderOrganizationsList() {
            const orgList = document.getElementById('org-list');
            const orgCount = document.getElementById('org-count');

            const orgs = Object.entries(auditingData.organizations);
            orgCount.textContent = orgs.length;

            orgList.innerHTML = '';

            orgs.forEach(([orgId, org]) => {
                const item = document.createElement('div');
                item.className = 'org-item';
                item.onclick = () => selectOrganization(orgId);

                const coverage = parseInt(org.coverage.percentage);
                const riskClass = org.average_risk > 0.66 ? 'high' :
                    org.average_risk > 0.33 ? 'medium' : 'low';

                item.innerHTML = `
                    <div class="org-name">${org.name}</div>
                    <div class="org-meta">
                        <span class="org-industry">${coverage}% done</span>
                        <span class="org-risk ${riskClass}">${(org.average_risk * 100).toFixed(0)}% risk</span>
                    </div>
                `;

                orgList.appendChild(item);
            });
        }

        function selectOrganization(orgId) {
            currentOrgId = orgId;

            // Update active state
            document.querySelectorAll('.org-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget?.classList.add('active');

            // Hide empty state, show detail
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('org-detail').style.display = 'block';

            // Render both tabs
            renderProgressTab(orgId);
            renderAnalysisTab(orgId);
        }

        function renderProgressTab(orgId) {
            const org = auditingData.organizations[orgId];
            const coverage = org.coverage;

            document.getElementById('progress-org-name').textContent = org.name;
            document.getElementById('progress-completed').textContent = `${coverage.completed}/${coverage.total}`;
            document.getElementById('progress-percentage').textContent = coverage.percentage + '%';

            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = coverage.percentage + '%';
            progressBar.textContent = coverage.percentage + '%';

            // Category progress
            const categoryGrid = document.getElementById('category-progress-grid');
            categoryGrid.innerHTML = '';

            for (const [catName, catCov] of Object.entries(coverage.byCategory)) {
                const item = document.createElement('div');
                item.className = 'category-progress-item';
                item.innerHTML = `
                    <div class="category-name-small">${catName}</div>
                    <div class="category-bar">
                        <div class="category-bar-fill" style="width: ${catCov.percentage}%"></div>
                    </div>
                    <div class="category-stat">${catCov.completed}/${catCov.total} (${catCov.percentage}%)</div>
                `;
                categoryGrid.appendChild(item);
            }

            // Indicator completion grid
            const grid = document.getElementById('indicator-completion-grid');
            grid.innerHTML = '';

            for (let cat = 1; cat <= 10; cat++) {
                for (let ind = 1; ind <= 10; ind++) {
                    const indicatorId = `${cat}.${ind}`;
                    const isCompleted = coverage.completedList.includes(indicatorId);
                    const cellClass = isCompleted ? 'completed' : 'missing';

                    const cell = document.createElement('div');
                    cell.className = `indicator-cell ${cellClass}`;

                    // Number (large)
                    const number = document.createElement('div');
                    number.className = 'indicator-cell-number';
                    number.textContent = indicatorId;

                    // Actions (two buttons)
                    const actions = document.createElement('div');
                    actions.className = 'indicator-cell-actions';

                    // Button 1: Info (Quick Reference)
                    const infoBtn = document.createElement('button');
                    infoBtn.className = 'indicator-cell-btn';
                    infoBtn.textContent = '‚ÑπÔ∏è';
                    infoBtn.title = 'Quick Reference';
                    infoBtn.onclick = (e) => {
                        e.stopPropagation();
                        const indicator = organizationsData?.organizations[currentOrgId]?.indicators[indicatorId];
                        showIndicatorDetail(indicatorId, indicator, currentOrgId, isCompleted ? 'edit' : 'new');
                    };

                    // Button 2: Direct to Client
                    const clientBtn = document.createElement('button');
                    clientBtn.className = 'indicator-cell-btn';
                    clientBtn.textContent = isCompleted ? '‚úèÔ∏è' : 'üìù';
                    clientBtn.title = isCompleted ? 'Modifica Scheda' : 'Compila Scheda';
                    clientBtn.onclick = (e) => {
                        e.stopPropagation();
                        const mode = isCompleted ? 'edit' : 'new';
                        window.open(`/client/cpf_client_json.html?indicator=${indicatorId}&lang=en-US&mode=${mode}&org_id=${currentOrgId}`, '_blank');
                    };

                    actions.appendChild(infoBtn);
                    actions.appendChild(clientBtn);

                    cell.appendChild(number);
                    cell.appendChild(actions);

                    if (!isCompleted) {
                        cell.style.opacity = '0.6';
                    }

                    grid.appendChild(cell);
                }
            }

            // Missing indicators
            const missingContainer = document.getElementById('missing-indicators-container');
            if (coverage.missing > 0) {
                missingContainer.innerHTML = `
                    <div class="missing-list">
                        <div class="missing-title">‚ö†Ô∏è Missing Indicators (${coverage.missing})</div>
                        <div class="missing-indicators">${coverage.missingList.join(', ')}</div>
                    </div>
                `;
            } else {
                missingContainer.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-top: 15px; color: #155724; font-weight: 600;">
                        ‚úÖ All indicators completed!
                    </div>
                `;
            }
        }

        function renderAnalysisTab(orgId) {
            const orgData = organizationsData.organizations[orgId];

            if (!orgData) {
                console.error('Organization not found in organizations.json');
                return;
            }

            // Run Bayesian analysis
            const analysis = BAYESIAN.analyzeOrganization(orgData);

            // Update overall risk card
            const riskPct = (analysis.overall_risk * 100).toFixed(1);
            document.getElementById('overall-risk-value').textContent = riskPct + '%';
            document.getElementById('overall-risk-bar').style.width = riskPct + '%';

            const riskClass = analysis.overall_risk > 0.66 ? 'high' :
                analysis.overall_risk > 0.33 ? 'medium' : 'low';
            document.getElementById('overall-risk-bar').className = `risk-bar-fill ${riskClass}`;

            document.getElementById('confidence-value').textContent = (analysis.confidence * 100).toFixed(0) + '%';

            const trendEl = document.getElementById('trend-value');
            trendEl.textContent = analysis.trend;
            trendEl.className = `meta-value trend ${analysis.trend}`;

            const lastUpdated = new Date(analysis.last_calculated);
            document.getElementById('last-updated').textContent = lastUpdated.toLocaleString();

            // Render category heatmap
            renderCategoryHeatmap(analysis.by_category);

            // Render prioritization table
            renderPrioritizationTable(analysis.prioritization);

            // Render convergence chart
            renderConvergenceChart(orgData);

            // Render indicator grid
            renderIndicatorGrid(orgData.indicators);
        }

        function renderCategoryHeatmap(categories) {
            const container = document.getElementById('category-heatmap');
            container.innerHTML = '';

            const CATEGORY_NAMES = {
                authority: 'Authority',
                temporal: 'Temporal',
                social: 'Social',
                affective: 'Affective',
                cognitive: 'Cognitive',
                group: 'Group',
                stress: 'Stress',
                unconscious: 'Unconscious',
                ai: 'AI',
                convergent: 'Convergent'
            };

            Object.entries(categories).forEach(([name, data]) => {
                const tile = document.createElement('div');
                const risk = data.value;
                const riskPct = (risk * 100).toFixed(0);

                const riskClass = risk > 0.66 ? 'high' : risk > 0.33 ? 'medium' : 'low';

                tile.className = `category-tile ${riskClass}`;
                tile.innerHTML = `
                    <div class="category-name">${CATEGORY_NAMES[name]}</div>
                    <div class="category-risk">${riskPct}%</div>
                    <div class="category-conf">conf: ${(data.confidence * 100).toFixed(0)}%</div>
                `;

                container.appendChild(tile);
            });
        }

        function renderPrioritizationTable(priorities) {
            const tbody = document.querySelector('#prioritization-table tbody');
            tbody.innerHTML = '';

            priorities.forEach((item, idx) => {
                const row = document.createElement('tr');

                const recClass = item.recommendation === 'critical' ? 'critical' :
                    item.recommendation === 'review' ? 'review' : 'monitor';

                row.innerHTML = `
                    <td>${idx + 1}</td>
                    <td><strong>${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</strong></td>
                    <td>${(item.risk * 100).toFixed(0)}%</td>
                    <td>${(item.confidence * 100).toFixed(0)}%</td>
                    <td><strong>${item.priority_score.toFixed(2)}</strong></td>
                    <td>${item.downstream_impact.toFixed(2)}</td>
                    <td><span class="recommendation ${recClass}">${item.recommendation}</span></td>
                `;

                tbody.appendChild(row);
            });
        }

        function renderIndicatorGrid(indicators) {
            const container = document.getElementById('indicator-grid');
            container.innerHTML = '';

            for (let cat = 1; cat <= 10; cat++) {
                for (let ind = 1; ind <= 10; ind++) {
                    const id = `${cat}.${ind}`;
                    const indicator = indicators[id];

                    if (indicator) {
                        const tile = document.createElement('div');
                        const risk = indicator.current_bayesian;
                        const riskClass = risk > 0.66 ? 'high' : risk > 0.33 ? 'medium' : 'low';

                        tile.className = `indicator-tile ${riskClass}`;
                        tile.textContent = id;
                        tile.title = `Indicator ${id}: ${(risk * 100).toFixed(0)}%`;
                        tile.onclick = () => showIndicatorDetail(id, indicator);

                        container.appendChild(tile);
                    }
                }
            }
        }

        // Category mapping for GitHub URLs
        const CATEGORY_MAP = {
            '1': 'authority',
            '2': 'temporal',
            '3': 'social',
            '4': 'affective',
            '5': 'cognitive',
            '6': 'group',
            '7': 'stress',
            '8': 'unconscious',
            '9': 'ai',
            '10': 'convergent'
        };

        async function showIndicatorDetail(id, indicator, orgId, mode) {
            const modal = document.getElementById('indicator-modal');
            const titlePrefix = mode === 'edit' ? '‚úèÔ∏è Edit' : 'üìù New';
            document.getElementById('modal-indicator-title').textContent = `${titlePrefix} Indicator ${id} - Quick Reference`;

            const socLatest = indicator ? indicator.soc_values[indicator.soc_values.length - 1] : null;
            const humanLatest = indicator ? indicator.human_values[indicator.human_values.length - 1] : null;

            const body = document.getElementById('modal-indicator-body');

            // Show loading state
            body.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="margin: 0 auto 20px;"></div>
                    <p>Loading Quick Reference from GitHub...</p>
                </div>
            `;

            modal.style.display = 'block';

            try {
                // Construct GitHub URL
                const [categoryNum, indicatorNum] = id.split('.');
                const categoryName = CATEGORY_MAP[categoryNum];
                const url = `https://raw.githubusercontent.com/xbeat/CPF/main/auditor%20field%20kit/interactive/en-US/${categoryNum}.x-${categoryName}/indicator_${id}.json`;

                console.log('Fetching Quick Reference from:', url);

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Quick Reference not found`);
                }

                const fieldKit = await response.json();

                // Render Quick Reference + Bayesian Data (if available)
                body.innerHTML = `
                    <div class="indicator-detail">
                        ${indicator ? `
                        <!-- Bayesian Stats -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: var(--primary);">üìä Bayesian Analysis</h3>
                            <div class="detail-row">
                                <strong>Merged Risk Value:</strong>
                                <span style="font-size: 24px; color: ${indicator.current_bayesian > 0.66 ? 'var(--danger)' : indicator.current_bayesian > 0.33 ? 'var(--warning)' : 'var(--success)'}">
                                    ${(indicator.current_bayesian * 100).toFixed(1)}%
                                </span>
                            </div>
                            <div class="detail-row">
                                <strong>SOC Assessments:</strong> ${indicator.soc_values.length} data points
                                ${socLatest ? `<br><small>Latest: ${(socLatest.value * 100).toFixed(1)}% (${new Date(socLatest.timestamp).toLocaleString()})</small>` : ''}
                            </div>
                            <div class="detail-row">
                                <strong>Human Assessments:</strong> ${indicator.human_values.length} audits
                                ${humanLatest ? `<br><small>Latest: ${(humanLatest.value * 100).toFixed(1)}% by ${humanLatest.assessor} (${new Date(humanLatest.timestamp).toLocaleString()})</small>` : ''}
                            </div>
                            <div class="detail-row">
                                <strong>Last Updated:</strong> ${new Date(indicator.last_updated).toLocaleString()}
                            </div>
                        </div>
                        ` : `
                        <!-- Missing Indicator Notice -->
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--warning);">
                            <h3 style="margin: 0 0 10px 0; color: var(--warning);">‚ö†Ô∏è Indicator Not Yet Compiled</h3>
                            <p style="margin: 0;">This indicator has not been assessed yet. Click the button below to compile a new assessment.</p>
                        </div>
                        `}

                        <!-- Quick Reference -->
                        <div>
                            <h3 style="margin: 0 0 15px 0; color: var(--primary);">üìö Quick Reference</h3>

                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--secondary); margin-bottom: 10px;">Title</h4>
                                <p style="font-size: 18px; font-weight: 600;">${fieldKit.title || 'N/A'}</p>
                                <p style="color: var(--text-light);">${fieldKit.subtitle || ''}</p>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--secondary); margin-bottom: 10px;">Category</h4>
                                <p>${fieldKit.category || 'N/A'}</p>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--secondary); margin-bottom: 10px;">Description</h4>
                                <p style="line-height: 1.6;">${fieldKit.description?.short || 'No description available'}</p>
                            </div>

                            ${fieldKit.description?.context ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--secondary); margin-bottom: 10px;">Context</h4>
                                <p style="line-height: 1.6;">${fieldKit.description.context}</p>
                            </div>
                            ` : ''}

                            ${fieldKit.description?.impact ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--secondary); margin-bottom: 10px;">Impact</h4>
                                <p style="line-height: 1.6;">${fieldKit.description.impact}</p>
                            </div>
                            ` : ''}

                            ${fieldKit.risk_scenarios && fieldKit.risk_scenarios.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--secondary); margin-bottom: 10px;">Risk Scenarios</h4>
                                ${fieldKit.risk_scenarios.slice(0, 3).map((scenario, idx) => `
                                    <div style="background: #fff3cd; padding: 15px; border-left: 4px solid var(--warning); margin-bottom: 10px;">
                                        <strong>${scenario.title || 'Scenario ' + (idx + 1)}</strong>
                                        <p style="margin-top: 5px;">${scenario.description || ''}</p>
                                        ${scenario.likelihood ? `<small>Likelihood: ${scenario.likelihood}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}

                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                                <a href="/client/cpf_client_json.html?indicator=${id}&lang=en-US&mode=${mode}&org_id=${orgId}"
                                   target="_blank"
                                   style="display: inline-block; background: var(--primary); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-right: 15px;">
                                    ${mode === 'edit' ? '‚úèÔ∏è Modifica Scheda' : 'üìù Compila Nuova Scheda'}
                                </a>
                                <a href="${url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                                    üìÑ View Full Field Kit JSON on GitHub ‚Üí
                                </a>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading Quick Reference:', error);

                // Fallback to basic info
                body.innerHTML = `
                    <div class="indicator-detail">
                        ${indicator ? `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: var(--primary);">üìä Bayesian Analysis</h3>
                            <div class="detail-row">
                                <strong>Merged Risk Value:</strong>
                                <span style="font-size: 24px; color: ${indicator.current_bayesian > 0.66 ? 'var(--danger)' : indicator.current_bayesian > 0.33 ? 'var(--warning)' : 'var(--success)'}">
                                    ${(indicator.current_bayesian * 100).toFixed(1)}%
                                </span>
                            </div>
                            <div class="detail-row">
                                <strong>SOC Assessments:</strong> ${indicator.soc_values.length} data points
                                ${socLatest ? `<br><small>Latest: ${(socLatest.value * 100).toFixed(1)}% (${new Date(socLatest.timestamp).toLocaleString()})</small>` : ''}
                            </div>
                            <div class="detail-row">
                                <strong>Human Assessments:</strong> ${indicator.human_values.length} audits
                                ${humanLatest ? `<br><small>Latest: ${(humanLatest.value * 100).toFixed(1)}% by ${humanLatest.assessor} (${new Date(humanLatest.timestamp).toLocaleString()})</small>` : ''}
                            </div>
                            <div class="detail-row">
                                <strong>Last Updated:</strong> ${new Date(indicator.last_updated).toLocaleString()}
                            </div>
                        </div>
                        ` : `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--warning);">
                            <h3 style="margin: 0 0 10px 0; color: var(--warning);">‚ö†Ô∏è Indicator Not Yet Compiled</h3>
                            <p style="margin: 0;">This indicator has not been assessed yet. Click the button below to compile a new assessment.</p>
                        </div>
                        `}

                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                            <strong>‚ö†Ô∏è Quick Reference Not Available</strong>
                            <p style="margin-top: 10px;">Could not load Quick Reference from GitHub: ${error.message}</p>
                            <p style="margin-top: 10px;">The Field Kit JSON might not exist yet for this indicator.</p>
                        </div>

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                            <a href="/client/cpf_client_json.html?indicator=${id}&lang=en-US&mode=${mode}&org_id=${orgId}"
                               target="_blank"
                               style="display: inline-block; background: var(--primary); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600;">
                                ${mode === 'edit' ? '‚úèÔ∏è Modifica Scheda' : 'üìù Compila Nuova Scheda'}
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        function closeIndicatorModal() {
            document.getElementById('indicator-modal').style.display = 'none';
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Redraw convergence chart if switching to analysis tab
            if (tabName === 'analysis' && currentOrgId && organizationsData) {
                const orgData = organizationsData.organizations[currentOrgId];
                if (orgData) {
                    setTimeout(() => renderConvergenceChart(orgData), 100);
                }
            }
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('indicator-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</body>
</html>
