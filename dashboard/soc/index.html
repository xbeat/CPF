<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPF Dashboard - SOC + Bayesian Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="../shared/styles.css">
    <link rel="stylesheet" href="../auditing/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%) !important;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <a href="../index.html" style="display: inline-block; color: white; text-decoration: none; opacity: 0.9; margin-bottom: 10px; font-size: 14px; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                        ‚Üê Back to Dashboard
                    </a>
                    <h1>‚ö†Ô∏è CPF SOC Dashboard <span style="font-size: 0.6em; opacity: 0.85;">v1.0</span></h1>
                    <p class="subtitle">SOC Integration + Bayesian Cross-Indicator Analysis</p>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <!-- Open Button (shown when sidebar is hidden) -->
                    <button class="sidebar-open-btn" id="sidebarOpenBtn" onclick="openSidebar()" title="Show organizations">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="18"></rect>
                            <rect x="14" y="3" width="7" height="18"></rect>
                        </svg>
                        Organizations
                    </button>
                    <button class="sidebar-open-btn" onclick="openCreateOrgModal()" title="Create new organization" style="display: inline-flex;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Organization
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="dashboard-main" id="dashboardMain">
            <!-- Sidebar: Organizations List -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; margin-right: 15px;">
                        <h2 style="margin: 0;">Organizations</h2>
                        <span id="org-count" class="badge">0</span>
                    </div>
                    <!-- Close Button (in sidebar) -->
                    <button class="sidebar-close-btn" id="sidebarCloseBtn" onclick="closeSidebar()" title="Hide sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                </div>
                <div class="sidebar-controls">
                    <!-- Search and Sort Controls -->
                    <div class="org-controls">
                        <div class="search-box">
                            <input type="text" id="org-search" class="search-input" placeholder="üîç Search organizations..." oninput="filterAndSortOrganizations()">
                        </div>
                        <div class="controls-row">
                            <select id="org-sort" class="sort-select" onchange="filterAndSortOrganizations()">
                                <option value="created_at">üìÖ Date Created</option>
                                <option value="name">üî§ Name</option>
                                <option value="risk">‚ö†Ô∏è Risk Score</option>
                                <option value="completion">üìä Completion %</option>
                                <option value="updated_at">üîÑ Last Updated</option>
                                <option value="assessments">üìù Assessments</option>
                                <option value="industry">üè¢ Industry</option>
                                <option value="country">üåç Country</option>
                            </select>
                            <button id="sort-direction" class="sort-direction-btn" onclick="toggleSortDirection()" title="Toggle sort direction">
                                ‚¨áÔ∏è
                            </button>
                            <button id="reset-filters" class="reset-btn" onclick="resetFilters()" title="Reset all filters">
                                üîÑ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div id="org-list" class="org-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </aside>

            <!-- Content Area -->
            <main class="content">
                <!-- Loading State -->
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading organizations data...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <h2>üëã Welcome to CPF Dashboard</h2>
                    <p>Select an organization from the sidebar to view analysis</p>
                </div>

                <!-- Organization Detail View -->
                <div id="org-detail" class="org-detail" style="display: none;">
                    <!-- Bayesian Explanation -->
                    <div class="section" style="background: #eff6ff; border-left: 4px solid var(--primary); padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                        <h3 style="margin: 0 0 12px 0; color: var(--primary); font-size: 18px;">üß† About Bayesian Cross-Indicator Analysis</h3>
                        <p style="margin: 0 0 10px 0; line-height: 1.6; color: var(--text);">
                            This dashboard uses <strong>Bayesian inference</strong> to intelligently merge data from two sources:
                            machine-generated SOC (Security Operations Center) data and human auditor assessments. The Bayesian approach
                            provides a probabilistic framework that weighs evidence from both sources, considering their confidence levels
                            and interdependencies.
                        </p>
                        <p style="margin: 0; line-height: 1.6; color: var(--text);">
                            <strong>Key features:</strong> Cross-category dependency modeling (e.g., high Authority risk influences Social risk),
                            weighted aggregation (human assessments weighted 1.5√ó for higher trust), confidence-based analysis,
                            and automated prioritization for remediation planning.
                        </p>
                    </div>

                    <!-- Overall Risk Card -->
                    <div class="risk-card">
                        <div class="risk-score-section">
                            <div class="risk-label">Overall Organizational Risk</div>
                            <div class="risk-value" id="overall-risk-value">0%</div>
                            <div class="risk-bar-container">
                                <div class="risk-bar-fill" id="overall-risk-bar"></div>
                            </div>
                        </div>
                        <div class="risk-metadata">
                            <div class="meta-item">
                                <span class="meta-label">Confidence</span>
                                <span class="meta-value" id="confidence-value">0%</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Trend</span>
                                <span class="meta-value trend" id="trend-value">-</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Last Updated</span>
                                <span class="meta-value" id="last-updated">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Category Heatmap -->
                    <section class="section">
                        <h3 class="section-title">üìä Risk by Category</h3>
                        <div id="category-heatmap" class="category-heatmap">
                            <!-- Populated by JS -->
                        </div>
                    </section>

                    <!-- Security Radar Chart -->
                    <section class="section">
                        <h3 class="section-title">üéØ Security Risk Radar</h3>
                        <p class="section-desc">Visual representation of risk and confidence across all categories</p>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
                            <!-- Radar Chart Canvas -->
                            <div style="flex: 1; min-width: 400px; max-width: 600px; margin: 0 auto;">
                                <canvas id="securityRadarChart"></canvas>
                            </div>
                            <!-- Legend and Stats -->
                            <div style="flex: 1; min-width: 300px; background: var(--bg-gray); padding: 20px; border-radius: 12px;">
                                <h4 style="margin: 0 0 15px 0; color: var(--primary);">üìä Quick Stats</h4>
                                <div id="radarStats">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Prioritization Table -->
                    <section class="section">
                        <h3 class="section-title">üéØ Prioritization Matrix</h3>
                        <p class="section-desc">Categories ordered by priority for remediation (risk √ó weight + downstream impact)</p>
                        <div class="table-container">
                            <table id="prioritization-table" class="prioritization-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Category</th>
                                        <th>Risk</th>
                                        <th>Confidence</th>
                                        <th>Priority Score</th>
                                        <th>Downstream Impact</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- SOC vs Human Convergence -->
                    <section class="section">
                        <h3 class="section-title">üîó SOC vs Human Convergence</h3>
                        <p class="section-desc">Comparison of machine (SOC) and human (auditor) assessments</p>
                        <div id="convergence-chart" class="convergence-chart">
                            <canvas id="convergence-canvas"></canvas>
                        </div>
                    </section>

                    <!-- Indicator Grid (100 tiles) -->
                    <section class="section">
                        <h3 class="section-title">üîç Indicator Matrix (100 Indicators)</h3>
                        <p class="section-desc">Click any indicator for detailed breakdown</p>
                        <div class="zoom-controls">
                            <span class="zoom-label">Zoom:</span>
                            <button class="zoom-btn active" onclick="setMatrixZoom('indicator', 100)">100%</button>
                            <button class="zoom-btn" onclick="setMatrixZoom('indicator', 75)">75%</button>
                            <button class="zoom-btn" onclick="setMatrixZoom('indicator', 50)">50%</button>
                        </div>
                        <div class="matrix-wrapper">
                            <div id="indicator-grid" class="indicator-grid matrix-scalable zoom-100">
                                <!-- Populated by JS: 10x10 grid -->
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Indicator Detail Modal -->
    <div id="indicator-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeIndicatorModal()">&times;</span>
            <h2 id="modal-indicator-title">Indicator X.Y</h2>
            <div id="modal-indicator-body">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Edit Organization Modal -->
    <div id="edit-org-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Edit Organization</h3>
                <span class="modal-close" onclick="closeEditOrgModal()">&times;</span>
            </div>
            <form id="edit-org-form" onsubmit="saveOrganizationEdit(event)">
                <div class="form-group">
                    <label class="form-label">Organization Name <span class="required">*</span></label>
                    <input type="text" id="edit-org-name" class="form-input" required placeholder="ACME Corporation">
                </div>
                <div class="form-group">
                    <label class="form-label">Industry <span class="required">*</span></label>
                    <select id="edit-org-industry" class="form-select" required>
                        <option value="">Select industry...</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Retail">Retail</option>
                        <option value="Education">Education</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Government">Government</option>
                        <option value="Energy">Energy</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Size <span class="required">*</span></label>
                    <select id="edit-org-size" class="form-select" required>
                        <option value="">Select size...</option>
                        <option value="small">Small (&lt;50 employees)</option>
                        <option value="medium">Medium (50-500 employees)</option>
                        <option value="enterprise">Enterprise (&gt;500 employees)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Country <span class="required">*</span></label>
                    <input type="text" id="edit-org-country" class="form-input" required maxlength="2" placeholder="US" style="text-transform: uppercase;">
                    <div class="form-helper">ISO 3166-1 alpha-2 code (2 letters, e.g., US, IT, GB)</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Language <span class="required">*</span></label>
                    <select id="edit-org-language" class="form-select" required>
                        <option value="en-US">English (US)</option>
                        <option value="it-IT">Italian (IT)</option>
                        <option value="es-ES">Spanish (ES)</option>
                        <option value="fr-FR">French (FR)</option>
                        <option value="de-DE">German (DE)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="edit-org-notes" class="form-textarea" placeholder="Additional notes..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditOrgModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-org-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Delete Organization</h3>
                <span class="modal-close" onclick="closeDeleteOrgModal()">&times;</span>
            </div>
            <p>Are you sure you want to delete <strong id="delete-org-name"></strong>?</p>
            <p style="color: var(--danger); font-size: 14px;">This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteOrgModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteOrganization()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Category Description Modal -->
    <div id="category-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="category-modal-title">Category</h3>
                <span class="modal-close" onclick="closeCategoryModal()">&times;</span>
            </div>
            <div id="category-modal-body" style="padding: 20px;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Create Organization Modal -->
    <div id="org-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="org-modal-title">Create New Organization</h3>
                <span class="modal-close" onclick="closeOrgModal()">&times;</span>
            </div>
            <form id="org-form" onsubmit="saveOrganization(event)">
                <div class="form-group">
                    <label class="form-label">Organization ID <span class="required">*</span></label>
                    <input type="text" id="org-id-input" class="form-input" required pattern="org-[a-z0-9-]+" placeholder="org-example-001">
                    <div class="form-helper">Format: org-yourname-001 (lowercase, hyphens allowed)</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Organization Name <span class="required">*</span></label>
                    <input type="text" id="org-name-input" class="form-input" required placeholder="ACME Corporation">
                </div>
                <div class="form-group">
                    <label class="form-label">Industry <span class="required">*</span></label>
                    <select id="org-industry-input" class="form-select" required>
                        <option value="">Select industry...</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Retail">Retail</option>
                        <option value="Education">Education</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Government">Government</option>
                        <option value="Energy">Energy</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Size <span class="required">*</span></label>
                    <select id="org-size-input" class="form-select" required>
                        <option value="">Select size...</option>
                        <option value="small">Small (&lt;50 employees)</option>
                        <option value="medium">Medium (50-500 employees)</option>
                        <option value="enterprise">Enterprise (&gt;500 employees)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Country <span class="required">*</span></label>
                    <input type="text" id="org-country-input" class="form-input" required maxlength="2" placeholder="US" style="text-transform: uppercase;">
                    <div class="form-helper">ISO 3166-1 alpha-2 code (2 letters, e.g., US, IT, GB)</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Language <span class="required">*</span></label>
                    <select id="org-language-input" class="form-select" required>
                        <option value="en-US">English (US)</option>
                        <option value="it-IT">Italian (IT)</option>
                        <option value="es-ES">Spanish (ES)</option>
                        <option value="fr-FR">French (FR)</option>
                        <option value="de-DE">German (DE)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="org-notes-input" class="form-textarea" placeholder="Additional notes about this organization..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOrgModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-org-btn">Create Organization</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Shared UI utilities (must load first) -->
    <script src="../shared/ui-utils.js"></script>
    <script src="bayesian.js"></script>
    <script src="visualizations.js"></script>
    <script src="dashboard.js"></script>
</body>
</html>
