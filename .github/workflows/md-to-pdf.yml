name: Convert Markdown to PDF

on:
  workflow_dispatch:
    inputs:
      source_folder:
        description: 'Cartella con i file .md da convertire (es: cpf-soc-integration/docs/en-US, cpf-soc-integration/docs/it-IT)'
        required: true
        default: 'cpf-soc-integration/docs/en-US'
        type: string
      output_folder:
        description: 'Cartella dove salvare i PDF (lascia vuoto per stessa cartella del .md)'
        required: false
        default: ''
        type: string

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Pandoc and LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra texlive-xetex

    - name: Convert Markdown files to PDF
      run: |
        SOURCE_FOLDER="${{ github.event.inputs.source_folder }}"
        OUTPUT_FOLDER="${{ github.event.inputs.output_folder }}"

        echo "Source folder: $SOURCE_FOLDER"
        echo "Output folder: ${OUTPUT_FOLDER:-same as source}"

        # Verify source folder exists
        if [ ! -d "$SOURCE_FOLDER" ]; then
          echo "Error: Folder '$SOURCE_FOLDER' does not exist"
          exit 1
        fi

        # Create output folder if specified
        if [ -n "$OUTPUT_FOLDER" ]; then
          mkdir -p "$OUTPUT_FOLDER"
        fi

        # Find .md files in the specified folder (not recursive)
        find "$SOURCE_FOLDER" -maxdepth 1 -name "*.md" -type f | while read mdfile; do
          echo "========================================"
          echo "Converting: $mdfile"

          dir=$(dirname "$mdfile")
          filename=$(basename "$mdfile" .md)

          # Convert using pandoc with professional PDF settings
          if [ -n "$OUTPUT_FOLDER" ]; then
            output_path="$OUTPUT_FOLDER/$filename.pdf"
          else
            output_path="$dir/$filename.pdf"
          fi

          pandoc "$mdfile" \
            -o "$output_path" \
            --pdf-engine=xelatex \
            -V geometry:margin=1in \
            -V fontsize=11pt \
            -V documentclass=article \
            --toc \
            --toc-depth=3 \
            --highlight-style=tango \
            --shift-heading-level-by=-1 \
            2>&1 || echo "✗ Failed: $mdfile"

          if [ -f "$output_path" ]; then
            echo "✓ Created: $output_path"
          else
            echo "✗ Failed to create PDF for: $mdfile"
          fi
        done

    - name: List generated PDFs
      run: |
        OUTPUT_FOLDER="${{ github.event.inputs.output_folder }}"
        SOURCE_FOLDER="${{ github.event.inputs.source_folder }}"

        if [ -n "$OUTPUT_FOLDER" ]; then
          echo "PDFs in $OUTPUT_FOLDER:"
          ls -la "$OUTPUT_FOLDER"/*.pdf 2>/dev/null || echo "No PDFs found"
        else
          echo "PDFs in $SOURCE_FOLDER:"
          ls -la "$SOURCE_FOLDER"/*.pdf 2>/dev/null || echo "No PDFs found"
        fi

    - name: Commit PDFs to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        OUTPUT_FOLDER="${{ github.event.inputs.output_folder }}"
        SOURCE_FOLDER="${{ github.event.inputs.source_folder }}"

        # Add PDFs from the correct folder
        if [ -n "$OUTPUT_FOLDER" ]; then
          git add "$OUTPUT_FOLDER"/*.pdf 2>/dev/null || true
        else
          git add "$SOURCE_FOLDER"/*.pdf 2>/dev/null || true
        fi

        if git diff --staged --quiet; then
          echo "No new PDFs to commit"
        else
          git commit -m "docs: Add PDF versions from ${{ github.event.inputs.source_folder }}"
          git push
          echo "PDFs committed and pushed to repository"
        fi
