name: Compile LaTeX to PDF

on:
  workflow_dispatch:
    inputs:
      source_folder:
        description: 'Cartella con i file .tex da compilare (es: research, vulnerabilities, .)'
        required: true
        default: '.'
        type: string
      output_folder:
        description: 'Cartella dove salvare i PDF (lascia vuoto per stessa cartella del .tex)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install TeX Live
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-full latexmk

    - name: Compile LaTeX files in specified folder
      run: |
        SOURCE_FOLDER="${{ github.event.inputs.source_folder }}"
        OUTPUT_FOLDER="${{ github.event.inputs.output_folder }}"

        echo "Source folder: $SOURCE_FOLDER"
        echo "Output folder: ${OUTPUT_FOLDER:-same as source}"

        # Verify source folder exists
        if [ ! -d "$SOURCE_FOLDER" ]; then
          echo "Error: Folder '$SOURCE_FOLDER' does not exist"
          exit 1
        fi

        # Create output folder if specified
        if [ -n "$OUTPUT_FOLDER" ]; then
          mkdir -p "$OUTPUT_FOLDER"
        fi

        # Find .tex files in the specified folder (not recursive)
        find "$SOURCE_FOLDER" -maxdepth 1 -name "*.tex" -type f | while read texfile; do
          echo "========================================"
          echo "Compiling: $texfile"

          dir=$(dirname "$texfile")
          filename=$(basename "$texfile" .tex)

          # Compile
          cd "$dir"
          pdflatex -interaction=nonstopmode -halt-on-error "$filename.tex" || true
          pdflatex -interaction=nonstopmode -halt-on-error "$filename.tex" || true

          # Move PDF to output folder if specified, otherwise leave in place
          if [ -f "$filename.pdf" ]; then
            if [ -n "$OUTPUT_FOLDER" ]; then
              mv "$filename.pdf" "$GITHUB_WORKSPACE/$OUTPUT_FOLDER/"
              echo "✓ Created: $OUTPUT_FOLDER/$filename.pdf"
            else
              echo "✓ Created: $dir/$filename.pdf"
            fi
          else
            echo "✗ Failed: $texfile"
          fi

          # Clean up auxiliary files
          rm -f *.aux *.log *.toc *.out *.lof *.lot *.bbl *.blg *.idx *.ind *.ilg *.fls *.fdb_latexmk *.synctex.gz

          cd "$GITHUB_WORKSPACE"
        done

    - name: List generated PDFs
      run: |
        OUTPUT_FOLDER="${{ github.event.inputs.output_folder }}"
        SOURCE_FOLDER="${{ github.event.inputs.source_folder }}"

        if [ -n "$OUTPUT_FOLDER" ]; then
          echo "PDFs in $OUTPUT_FOLDER:"
          ls -la "$OUTPUT_FOLDER"/*.pdf 2>/dev/null || echo "No PDFs found"
        else
          echo "PDFs in $SOURCE_FOLDER:"
          ls -la "$SOURCE_FOLDER"/*.pdf 2>/dev/null || echo "No PDFs found"
        fi

    - name: Commit PDFs to repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add -A *.pdf

        if git diff --staged --quiet; then
          echo "No new PDFs to commit"
        else
          git commit -m "Add compiled PDFs from ${{ github.event.inputs.source_folder }}"
          git push
          echo "PDFs committed and pushed to repository"
        fi
